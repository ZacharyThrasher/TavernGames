<div class="tavern-controls {{#if uiLocked}}locked{{/if}}">
  {{!-- Lobby state --}}
  {{#if isLobby}}
  <div class="control-section">
    <h3><i class="fa-solid fa-users"></i> Join the Game</h3>
    {{#if canJoin}}
    <button type="button" class="btn btn-primary btn-large" data-action="join">
      <i class="fa-solid fa-chair"></i> Take a Seat
    </button>
    {{else if isInGame}}
    <button type="button" class="btn btn-secondary" data-action="leave">
      <i class="fa-solid fa-door-open"></i> Leave Table
    </button>
    {{/if}}
  </div>

  {{#if isGM}}
  <div class="control-section house-rules">
    <h3><i class="fa-solid fa-scroll"></i> House Rules</h3>
    <div class="setting-row">
      <label for="ante-input">
        <i class="fa-solid fa-coins"></i> Ante
      </label>
      <div class="setting-input">
        <input type="number" id="ante-input" name="ante" min="1" max="1000" value="{{ante}}" data-action="setAnte" />
        <span class="setting-suffix">gp</span>
      </div>
    </div>
    <div class="setting-row">
      <label for="game-mode-select">
        <i class="fa-solid fa-chess-knight"></i> Mode
      </label>
      <div class="setting-input">
        <select id="game-mode-select" name="gameMode" data-action="setGameMode" style="width: 100px; padding: 2px;">
          <option value="standard" {{#if (eq gameMode 'standard' )}}selected{{/if}}>Standard</option>
          <option value="goblin" {{#if (eq gameMode 'goblin' )}}selected{{/if}}>Goblin</option>
        </select>
      </div>
    </div>
    <div class="setting-row">
      <label for="starting-heat">
        <i class="fa-solid fa-fire"></i> Starting Heat
      </label>
      <div class="setting-input">
        <input type="number" id="starting-heat" name="startingHeat" min="5" max="30" value="{{startingHeat}}"
          data-action="setStartingHeat" />
      </div>
    </div>
    <div class="setting-row">
      <label for="theme-select">
        <i class="fa-solid fa-palette"></i> Theme
      </label>
      <div class="setting-input">
        <select id="theme-select" name="tableTheme" data-action="setTheme" style="width: 100px; padding: 2px;">
          <option value="sword-coast" {{#if (eq tableTheme 'sword-coast')}}selected{{/if}}>Sword Coast</option>
          <option value="goblin-den" {{#if (eq tableTheme 'goblin-den')}}selected{{/if}}>Goblin's Den</option>
          <option value="underdark" {{#if (eq tableTheme 'underdark')}}selected{{/if}}>Underdark</option>
          <option value="gilded-dragon" {{#if (eq tableTheme 'gilded-dragon')}}selected{{/if}}>Gilded Dragon</option>
          <option value="feywild" {{#if (eq tableTheme 'feywild')}}selected{{/if}}>Feywild</option>
        </select>
      </div>
    </div>
    <p class="hint">Cost to join each round and roll extra dice.</p>
  </div>

  <div class="control-section">
    <h3><i class="fa-solid fa-play"></i> Start Game</h3>
    {{#if hasPlayers}}
    <button type="button" class="btn btn-success btn-large" data-action="start">
      <i class="fa-solid fa-dice"></i> Deal the Dice!
    </button>
    <p class="hint">{{players.length}} player{{#if (gt players.length 1)}}s{{/if}} at the table</p>
    {{else}}
    <p class="hint">Waiting for players to join...</p>
    {{/if}}
  </div>
  {{/if}}

  <div class="control-section rules">
    <h3><i class="fa-solid fa-scroll"></i> Rules Summary</h3>
    {{#if isGoblinMode}}
    <ul class="rules-list">
      <li><strong>Chamber:</strong> Everyone rolls the same die each stage (d20 → d12 → d10 → d8 → d6 → d4 → Coin).</li>
      <li><strong>Natural 1:</strong> You die (score becomes 0).</li>
      <li><strong>Max Roll:</strong> Earn a Boot to kick a holder back in.</li>
      <li><strong>Hold:</strong> Only the current leader can Hold.</li>
      <li><strong>Coin Stage:</strong> After d4, flips continue until all players bust or Hold. Heads grows +2, +4, +8...</li>
      <li><strong>Disabled:</strong> Skills and Accusations are off.</li>
    </ul>
    {{else}}
    <ul class="rules-list">
      <li><strong>Deal:</strong> Everyone gets 2d10 (1 visible, 1 hole).</li>
      <li><strong>Betting:</strong> Buy dice (d4-d20) or <strong>Hold</strong>.</li>
      <li><strong>Skills:</strong> Use <strong>Cheat</strong>, <strong>Bump</strong>, <strong>Goad</strong>,
        <strong>Foresight</strong>, or <strong>Profile</strong>.
      </li>
      <li><strong>Duels:</strong> Ties are settled by rolling 1d20 + 1d4 per Hit.</li>
      <li><strong>Side Bets:</strong> Open for two full betting rounds. Winners split a side‑bet pool.</li>
    </ul>
    {{/if}}
  </div>
  {{/if}}

  {{!-- Playing state --}}
  {{#if isPlaying}}

  {{!-- V3: The Cut phase --}}
  {{#if isCutPhase}}
  {{#if isTheCutPlayer}}
  <div class="control-section cut-phase">
    <h3><i class="fa-solid fa-scissors"></i> The Cut</h3>
    <p class="cut-text">You rolled the lowest visible die. Re-roll your hole die?</p>
    <div class="cut-buttons">
      <button type="button" class="btn btn-success" data-action="useCut" data-reroll="true">
        <i class="fa-solid fa-dice"></i> Re-roll Hole Die
      </button>
      <button type="button" class="btn btn-secondary" data-action="useCut" data-reroll="false">
        <i class="fa-solid fa-check"></i> Keep It
      </button>
    </div>
  </div>
  {{else}}
  <div class="control-section waiting">
    <h3><i class="fa-solid fa-scissors"></i> The Cut</h3>
    <p class="waiting-text"><strong>{{theCutPlayerName}}</strong> is deciding...</p>
  </div>
  {{/if}}
  {{/if}}


  {{!-- V4: Dared Warning --}}
  {{#if isDared}}
  <div class="control-section dared-warning">
    <h3><i class="fa-solid fa-fire"></i> YOU ARE DARED!</h3>
    <p>Your Goad backfired! You <strong>MUST</strong> roll a d8 (Free) or Fold.</p>
  </div>
  {{/if}}

  {{#if myTurn}}
  {{!-- V3.4: During cut phase, ONLY show cut UI (handled above), not your-turn controls --}}
  {{!-- V3.4: During cut phase, ONLY show cut UI (handled above), not your-turn controls --}}
  {{#unless isCutPhase}}
  {{#if isBumpLocked}}
  <div class="control-section waiting">
    <h3><i class="fa-solid fa-lock"></i> Locked!</h3>
    <p class="waiting-text" style="color: #ffaaaa;">You were caught bumping!</p>
    <p class="waiting-text">Waiting for <strong>{{retaliationTargetName}}</strong> to retaliate...</p>
  </div>
  {{else}}
  <div class="control-section your-turn">
    <h3><i class="fa-solid fa-dice"></i> Your Turn!</h3>

    {{!-- V5.22: Themed Risk Warning --}}
    {{#if riskWarningText}}
    <div class="risk-warning-flavor {{riskLevel}}">
      <i class="fa-solid fa-triangle-exclamation"></i> {{riskWarningText}}
    </div>
    {{/if}}

    {{#if isOpeningPhase}}
    <p class="turn-hint phase-opening">
      <strong>Opening Round:</strong> Roll {{openingRollsRemaining}} more {{#if (eq openingRollsRemaining
      1)}}die{{else}}dice{{/if}}.
    </p>
    {{else}}
    {{#if isGoblinMode}}
    <p class="turn-hint phase-goblin">
      <strong>Chamber:</strong> Roll the current die (or Hold if you're the leader).
    </p>
    {{else}}
    <p class="turn-hint phase-betting">
      <strong>Betting Round:</strong> Choose your action!
    </p>
    {{/if}}
    {{/if}}
    {{#if isGoblinMode}}
    <p class="turn-hint phase-goblin">
      <strong>{{goblinStageLabel}}</strong>
    </p>
    {{/if}}

    {{#unless isHouse}}
    {{#unless isGoblinMode}}
    <div class="liquid-mode-toggle">
      <button type="button" class="btn-toggle-liquid {{#if liquidMode}}active{{/if}} {{#if isSloppy}}cutoff{{/if}}"
        data-action="toggleLiquidMode" {{#if isSloppy}}disabled{{/if}}
        title="Pay with your Liver! (Constitution Save)">
        <i class="fa-solid fa-beer-mug-empty"></i>
        {{#if isSloppy}}Cut Off{{else}}Put it on the Tab{{/if}}
      </button>
      {{#if isSloppy}}
      <div class="cutoff-stamp">CUT OFF</div>
      {{/if}}
    </div>
    {{/unless}}
    {{/unless}}

    {{!-- V3: Hit locked indicator --}}
    {{#if hunchLocked}}
    <p class="hunch-locked-warning">
      <i class="fa-solid fa-lock"></i> Your Foresight locked you in! You MUST roll {{#if hunchLockedDie}}a
      d{{hunchLockedDie}}{{else}}before your turn ends{{/if}}.
    </p>
    {{/if}}

    <div class="dice-buttons premium {{#if myTurn}}turn-stagger{{/if}} {{#if riskLevel}}risk-{{riskLevel}}{{/if}}">
      {{#each dice}}
      <button type="button"
        class="btn-die-premium {{#if this.costLabel}}has-cost{{/if}} {{#if this.isCoin}}btn-die-coin{{/if}} {{#if this.isUsed}}is-used{{/if}}"
        data-action="roll" data-die="{{this.value}}" {{#if this.disabled}}disabled{{/if}}
        title="{{this.label}} - {{this.strategy}}{{#if this.costLabel}} ({{this.costLabel}}){{/if}}">
        {{#if this.hunchDirection}}
        <span class="hunch-indicator {{this.hunchDirection}}" title="Foresight: {{this.hunchDirection}}">
          <i class="fa-solid fa-arrow-{{this.hunchDirection}}"></i>
        </span>
        {{/if}}
        {{#if this.hunchExactValue}}
        <span class="hunch-exact" title="Foresight: exact value">{{this.hunchExactValue}}</span>
        {{/if}}
        {{#if this.isCoin}}
        <i class="fa-solid fa-circle-dollar-to-slot die-icon"></i>
        {{else}}
        <img src="icons/svg/{{this.icon}}.svg" alt="{{this.label}}" class="die-icon" />
        {{/if}}
        <span class="die-label">{{this.label}}</span>
        {{#if this.costLabel}}
        <span
          class="die-cost {{#if (eq this.costLabel 'FREE')}}free{{/if}} {{#if (eq this.costLabel 'USED')}}used{{/if}}">{{this.costLabel}}</span>
        {{/if}}
      </button>
      {{/each}}
    </div>

    {{#if isBettingPhase}}
    <div class="main-actions">
      <button type="button" class="btn btn-hold" data-action="hold" {{#unless canHold}}disabled
        title="{{holdDisabledReason}}" {{/unless}}>
        <i class="fa-solid fa-hand"></i> Hold
      </button>
      {{#if isGoblinMode}}
      {{#if canBoot}}
      <button type="button" class="btn btn-secondary" data-action="boot" title="Kick a holder back in">
        <i class="fa-solid fa-shoe-prints"></i> Boot ({{goblinBoots}})
      </button>
      {{else}}
      <button type="button" class="btn btn-secondary" data-action="boot" disabled title="No Boots available">
        <i class="fa-solid fa-shoe-prints"></i> Boot ({{goblinBoots}})
      </button>
      {{/if}}
      {{else}}
      <button type="button" class="btn btn-fold" data-action="fold">
        <i class="fa-solid fa-door-open"></i> Fold {{#unless hasActed}}(50% back){{/unless}}
      </button>
      {{/if}}
    </div>
    {{/if}}
  </div>
  {{/if}}
  {{/unless}}

  {{!-- V3: Bonus Action Skills Section --}}
  {{#if isBettingPhase}}
  {{#unless isHouse}}
  {{#unless isGoblinMode}}
  <div class="control-section skill-section">
    <h4><i class="fa-solid fa-star"></i> Bonus Action (Skills)</h4>
    <div class="skill-buttons">
      {{#if canHunch}}
      <button type="button" class="btn btn-skill btn-hunch" data-action="hunch"
        title="WIS - Predict high/low before rolling">
        <i class="fa-solid fa-eye"></i> Foresight
        {{#if (eq ../lastSkillUsed "hunch")}}
        <span class="skill-sigil">*</span>
        {{/if}}
      </button>
      {{else}}
      <button type="button" class="btn btn-skill btn-hunch" disabled
        title="Foresight unavailable">
        <i class="fa-solid fa-eye"></i> Foresight
        {{#if (eq ../lastSkillUsed "hunch")}}
        <span class="skill-sigil">*</span>
        {{/if}}
      </button>
      {{/if}}

      {{#if canProfile}}
      <button type="button" class="btn btn-skill btn-profile" data-action="profile"
        title="INT - Learn target's hole die">
        <i class="fa-solid fa-user-secret"></i> Profile
        {{#if (eq ../lastSkillUsed "profile")}}
        <span class="skill-sigil">*</span>
        {{/if}}
      </button>
      {{else}}
      <button type="button" class="btn btn-skill btn-profile" disabled
        title="Profile unavailable">
        <i class="fa-solid fa-user-secret"></i> Profile
        {{#if (eq ../lastSkillUsed "profile")}}
        <span class="skill-sigil">*</span>
        {{/if}}
      </button>
      {{/if}}

      {{#if canGoad}}
      <button type="button" class="btn btn-skill btn-goad" data-action="goad"
        title="CHA - Force someone to roll again. Once per round.">
        <i class="fa-solid fa-comments"></i> Goad
        {{#if (eq ../lastSkillUsed "goad")}}
        <span class="skill-sigil">*</span>
        {{/if}}
      </button>
      {{else}}
      <button type="button" class="btn btn-skill btn-goad" disabled
        title="Goad unavailable">
        <i class="fa-solid fa-comments"></i> Goad
        {{#if (eq ../lastSkillUsed "goad")}}
        <span class="skill-sigil">*</span>
        {{/if}}
      </button>
      {{/if}}

      {{#if canBump}}
      <button type="button" class="btn btn-skill btn-bump" data-action="bumpTable"
        title="STR - Force a re-roll. Once per round.">
        <i class="fa-solid fa-hand-fist"></i> Bump
        {{#if (eq ../lastSkillUsed "bump")}}
        <span class="skill-sigil">*</span>
        {{/if}}
      </button>
      {{else}}
      <button type="button" class="btn btn-skill btn-bump" disabled
        title="Bump unavailable">
        <i class="fa-solid fa-hand-fist"></i> Bump
        {{#if (eq ../lastSkillUsed "bump")}}
        <span class="skill-sigil">*</span>
        {{/if}}
      </button>
      {{/if}}
    </div>
  </div>
  {{/unless}}
  {{/unless}}
  {{/if}}

  {{else}}
  <div class="control-section waiting">
    <h3><i class="fa-solid fa-hourglass-half"></i> Waiting</h3>
    {{#if currentPlayer}}
    <p class="waiting-text">
      <strong>{{currentPlayer.name}}</strong> is {{#if isCutPhase}}deciding on The Cut{{else}}rolling{{/if}}...
    </p>
    {{/if}}
    {{#if isOpeningPhase}}
    <p class="phase-label">Opening Round</p>
    {{else if isCutPhase}}
    <p class="phase-label">The Cut</p>
    {{else}}
    {{#if isGoblinMode}}
    <p class="phase-label">The Chamber</p>
    {{else}}
    <p class="phase-label">Betting Round</p>
    {{/if}}
    {{/if}}
    {{#if isGoblinMode}}
    <p class="phase-label">{{goblinStageLabel}}</p>
    {{/if}}
  </div>
  {{/if}}

  {{!-- Cheat button - available when you have dice --}}


  {{!-- Goad button moved to Skills section --}}

  {{!-- Bump Table button moved to Skills section --}}

  {{!-- Pending Bump Retaliation --}}
  {{#if canRetaliate}}
  <div class="control-section bump-retaliation">
    <h3><i class="fa-solid fa-hand"></i> Caught!</h3>
    {{#if isRetaliationTarget}}
    <p>You caught <strong>{{retaliationAttackerName}}</strong> bumping the table!</p>
    <p>Choose one of their dice to re-roll:</p>
    {{else}}
    <p class="gm-override-note"><strong>{{retaliationAttackerName}}</strong> is waiting for retaliation.</p>
    <p>Override and choose a die:</p>
    {{/if}}
    <div class="retaliation-dice">
      {{#each retaliationAttackerDice}}
      <button type="button" class="btn-retaliation-die" data-action="bumpRetaliation" data-die-index="{{this.index}}">
        <span class="retaliation-die-face">
          <img src="icons/svg/d{{this.die}}-grey.svg" alt="d{{this.die}}" class="retaliation-die-icon" />
          <span class="retaliation-die-result {{#if this.isHole}}hole{{/if}}">{{this.result}}</span>
        </span>
        <span class="die-type">d{{this.die}}</span>
      </button>
      {{/each}}
    </div>
  </div>
  {{/if}}

  {{#if isGM}}
  <div class="control-section gm-controls">
    <button type="button" class="btn btn-secondary btn-small" data-action="reveal">
      <i class="fa-solid fa-forward"></i> Skip to Staredown
    </button>
  </div>
  {{/if}}
  {{/if}}

  {{!-- Global Accuse Section (Available anytime during round) --}}
  {{#if canAccuse}}
  <div class="control-section accuse-section-global">
    <h3><i class="fa-solid fa-hand-point-right"></i> Accuse</h3>
    <div class="accuse-section">
      <label>Who do you suspect?</label>
      <div class="accuse-portraits">
        {{#each accuseTargets}}
        <div class="accuse-portrait" data-target-id="{{this.id}}" data-target-name="{{this.name}}" tabindex="0">
          <img src="{{this.img}}" alt="{{this.name}}" />
          <span class="portrait-name">{{this.name}}</span>
        </div>
        {{/each}}
      </div>
      <button type="button" class="btn btn-accuse" data-action="accuse" disabled>
        <i class="fa-solid fa-hand-point-right"></i> Accuse ({{accusationCost}}gp)
      </button>
    </div>
    <p class="hint">Click a portrait to select. Cost: 2× ante. Bounty: 5× ante if correct!</p>
  </div>
  {{/if}}

  {{!-- Side Bets Section (V4) --}}
  {{#if (or isPlaying isInspection)}}
  <div class="control-section side-bets-section">
    <h3><i class="fa-solid fa-sack-dollar"></i> Side Bets</h3>
    <p class="hint">Place bets within two full betting rounds. Winners split the pool.</p>
    <button type="button" class="btn btn-secondary btn-large" data-action="sideBet">
      <i class="fa-solid fa-coins"></i> Place Side Bet
    </button>
  </div>
  {{/if}}

  {{!-- Staredown / Accusation state --}}
  {{#if isInspection}}
  <div class="control-section staredown">
    <h3><i class="fa-solid fa-eye"></i> The Staredown</h3>

    <p class="staredown-text">The dice are revealed. But can you trust what you see?</p>
    <p class="staredown-warning"><i class="fa-solid fa-warning"></i> Accuse an innocent and you forfeit your winnings!
    </p>

    {{#if isInGame}}
    {{!-- V2.0: Scan action - investigate before accusing --}}


    {{/if}}


    {{#if isGM}}
    <button type="button" class="btn btn-success" data-action="skipInspection">
      <i class="fa-solid fa-trophy"></i> Finish Round
    </button>
    {{/if}}
  </div>
  {{/if}}

  {{!-- Revealing state --}}
  {{#if isRevealing}}
  <div class="control-section revealing">
    <h3><i class="fa-solid fa-eye"></i> Revealing...</h3>
    <p>All dice are being revealed!</p>
    <div class="reveal-animation">
      <i class="fa-solid fa-dice fa-spin"></i>
    </div>
  </div>
  {{/if}}

  {{!-- V2.0: Duel state --}}
  {{#if isDuel}}
  <div class="control-section duel">
    <h3><i class="fa-solid fa-swords"></i> The Duel!</h3>
    <p class="duel-announcement"><strong>Highest total wins the pot!</strong></p>
    <p class="duel-round">Round {{duel.round}}</p>

    <div class="duel-participants">
      {{#each duelParticipants}}
      <div class="duel-participant {{#if this.hasRolled}}rolled{{/if}}">
        <span class="participant-name">{{this.name}}</span>
        {{#if this.hasRolled}}
        <span class="participant-roll">{{this.roll}}</span>
        {{else}}
        <span class="participant-waiting">...</span>
        {{/if}}
      </div>
      {{/each}}
    </div>

    {{#if isMyDuel}}
    <button type="button" class="btn btn-primary btn-large" data-action="duelRoll">
      <i class="fa-solid fa-dice-d20"></i> Roll for the Duel!
    </button>
    {{else}}
    <p class="duel-waiting"><i class="fa-solid fa-hourglass-half"></i> Waiting for duelists...</p>
    {{/if}}
  </div>
  {{/if}}

  {{!-- Payout state --}}
  {{#if isPayout}}
  <div class="control-section payout">
    <h3><i class="fa-solid fa-trophy"></i> Round Complete!</h3>
    {{#if isInGame}}
    <button type="button" class="btn btn-secondary" data-action="leave">
      <i class="fa-solid fa-door-open"></i> Leave Table
    </button>
    {{/if}}
    {{#if isGM}}
    <button type="button" class="btn btn-success btn-large" data-action="newRound">
      <i class="fa-solid fa-rotate"></i> New Round
    </button>
    {{/if}}
  </div>
  {{/if}}
</div>
