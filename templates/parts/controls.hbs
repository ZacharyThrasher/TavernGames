<div class="tavern-controls">
  {{!-- Lobby state --}}
  {{#if isLobby}}
  <div class="control-section">
    <h3><i class="fa-solid fa-users"></i> Join the Game</h3>
    {{#if canJoin}}
    <button type="button" class="btn btn-primary btn-large" data-action="join">
      <i class="fa-solid fa-chair"></i> Take a Seat
    </button>
    {{else if isInGame}}
    <button type="button" class="btn btn-secondary" data-action="leave">
      <i class="fa-solid fa-door-open"></i> Leave Table
    </button>
    {{/if}}
  </div>

  {{#if isGM}}
  <div class="control-section house-rules">
    <h3><i class="fa-solid fa-scroll"></i> House Rules</h3>
    <div class="setting-row">
      <label for="ante-input">
        <i class="fa-solid fa-coins"></i> Ante
      </label>
      <div class="setting-input">
        <input type="number" id="ante-input" name="ante" min="1" max="1000" value="{{ante}}" data-action="setAnte" />
        <span class="setting-suffix">gp</span>
      </div>
    </div>
    <p class="hint">Cost to join each round and roll extra dice.</p>
  </div>

  <div class="control-section">
    <h3><i class="fa-solid fa-play"></i> Start Game</h3>
    {{#if hasPlayers}}
    <button type="button" class="btn btn-success btn-large" data-action="start">
      <i class="fa-solid fa-dice"></i> Deal the Dice!
    </button>
    <p class="hint">{{players.length}} player{{#if (gt players.length 1)}}s{{/if}} at the table</p>
    {{else}}
    <p class="hint">Waiting for players to join...</p>
    {{/if}}
  </div>
  {{/if}}

  <div class="control-section rules">
    <h3><i class="fa-solid fa-scroll"></i> Rules</h3>
    <ul>
      <li>Opening: everyone rolls <strong>2 dice</strong></li>
      <li>Then take turns: roll (costs {{ante}}gp) or hold</li>
      <li>Try to reach <strong>21</strong> without busting</li>
      <li>Highest total ≤21 wins the pot!</li>
    </ul>
  </div>
  {{/if}}

  {{!-- Playing state --}}
  {{#if isPlaying}}

  {{!-- V3: The Cut phase --}}
  {{#if isCutPhase}}
  {{#if isTheCutPlayer}}
  <div class="control-section cut-phase">
    <h3><i class="fa-solid fa-scissors"></i> The Cut</h3>
    <p class="cut-text">You rolled the lowest visible die. Re-roll your hole die?</p>
    <div class="cut-buttons">
      <button type="button" class="btn btn-success" data-action="useCut" data-reroll="true">
        <i class="fa-solid fa-dice"></i> Re-roll Hole Die
      </button>
      <button type="button" class="btn btn-secondary" data-action="useCut" data-reroll="false">
        <i class="fa-solid fa-check"></i> Keep It
      </button>
    </div>
  </div>
  {{else}}
  <div class="control-section waiting">
    <h3><i class="fa-solid fa-scissors"></i> The Cut</h3>
    <p class="waiting-text"><strong>{{theCutPlayerName}}</strong> is deciding...</p>
  </div>
  {{/if}}
  {{/if}}

  {{!-- V3: Goad Resist Option --}}
  {{#if canResistGoad}}
  <div class="control-section goad-resist">
    <h3><i class="fa-solid fa-comments"></i> You've Been Goaded!</h3>
    <p>{{goadedByName}} is pressuring you to roll.</p>
    <div class="goad-resist-buttons">
      <button type="button" class="btn btn-warning" data-action="resistGoad">
        <i class="fa-solid fa-coins"></i> Pay {{goadResistCost}}gp to Resist
      </button>
      <p class="hint">Or just roll a die to comply.</p>
    </div>
  </div>
  {{/if}}

  {{#if myTurn}}
  <div class="control-section your-turn">
    <h3><i class="fa-solid fa-dice"></i> Your Turn!</h3>

    {{#if isOpeningPhase}}
    <p class="turn-hint phase-opening">
      <strong>Opening Round:</strong> Roll {{openingRollsRemaining}} more {{#if (eq openingRollsRemaining
      1)}}die{{else}}dice{{/if}}.
    </p>
    {{else if isCutPhase}}
    {{!-- Handled above --}}
    {{else}}
    <p class="turn-hint phase-betting">
      <strong>Betting Round:</strong> Choose your action!
    </p>
    {{/if}}

    {{#unless isGM}}
    <div class="liquid-mode-toggle">
      <button type="button" class="btn-toggle-liquid {{#if liquidMode}}active{{/if}}" data-action="toggleLiquidMode"
        title="Pay with your Liver! (Constitution Save)">
        <i class="fa-solid fa-beer-mug-empty"></i> Put it on the Tab {{#if liquidMode}}(ON){{/if}}
      </button>
    </div>
    {{/unless}}

    {{!-- V3: Hit locked indicator --}}
    {{#if hunchLocked}}
    <p class="hunch-locked-warning">
      <i class="fa-solid fa-lock"></i> Your Hunch locked you in! You MUST roll {{#if hunchLockedDie}}a
      d{{hunchLockedDie}}{{else}}before your turn ends{{/if}}.
    </p>
    {{/if}}

    <div class="dice-buttons premium">
      {{#each dice}}
      <button type="button" class="btn-die-premium {{#if this.costLabel}}has-cost{{/if}}" data-action="roll"
        data-die="{{this.value}}"
        title="{{this.label}} - {{this.strategy}}{{#if this.costLabel}} ({{this.costLabel}}){{/if}}">
        <img src="icons/svg/{{this.icon}}.svg" alt="{{this.label}}" class="die-icon" />
        <span class="die-label">{{this.label}}</span>
        {{#if this.costLabel}}
        <span class="die-cost {{#if (eq this.costLabel 'FREE')}}free{{/if}}">{{this.costLabel}}</span>
        {{/if}}
      </button>
      {{/each}}
    </div>

    {{#if isBettingPhase}}
    <div class="main-actions">
      <button type="button" class="btn btn-hold" data-action="hold">
        <i class="fa-solid fa-hand"></i> Hold
      </button>
      <button type="button" class="btn btn-fold" data-action="fold">
        <i class="fa-solid fa-door-open"></i> Fold {{#unless hasActed}}(50% back){{/unless}}
      </button>
    </div>
    {{/if}}
  </div>

  {{!-- V3: Bonus Action Skills Section --}}
  {{#if isBettingPhase}}
  {{#unless isGM}}
  <div class="control-section skill-section">
    <h4><i class="fa-solid fa-star"></i> Bonus Action (Skills)</h4>
    <div class="skill-buttons">
      {{#if canHunch}}
      <button type="button" class="btn btn-skill btn-hunch" data-action="hunch"
        title="WIS - Predict high/low before rolling">
        <i class="fa-solid fa-eye"></i> Hunch
      </button>
      {{/if}}

      {{#if canProfile}}
      <button type="button" class="btn btn-skill btn-profile" data-action="profile"
        title="INT - Learn target's hole die">
        <i class="fa-solid fa-user-secret"></i> Profile
      </button>
      {{/if}}

      {{#if canGoad}}
      {{#if goadTargets.length}}
      <button type="button" class="btn btn-skill btn-goad" data-action="goad"
        title="CHA - Force someone to roll again. Once per round.">
        <i class="fa-solid fa-comments"></i> Goad
      </button>
      {{/if}}
      {{/if}}

      {{#if canBump}}
      {{#if bumpTargets.length}}
      <button type="button" class="btn btn-skill btn-bump" data-action="bumpTable"
        title="STR - Force a re-roll. Once per round.">
        <i class="fa-solid fa-hand-fist"></i> Bump
      </button>
      {{/if}}
      {{/if}}
    </div>
  </div>
  {{/unless}}
  {{/if}}

  {{else}}
  <div class="control-section waiting">
    <h3><i class="fa-solid fa-hourglass-half"></i> Waiting</h3>
    {{#if currentPlayer}}
    <p class="waiting-text">
      <strong>{{currentPlayer.name}}</strong> is {{#if isCutPhase}}deciding on The Cut{{else}}rolling{{/if}}...
    </p>
    {{/if}}
    {{#if isOpeningPhase}}
    <p class="phase-label">Opening Round</p>
    {{else if isCutPhase}}
    <p class="phase-label">The Cut</p>
    {{else}}
    <p class="phase-label">Betting Round</p>
    {{/if}}
  </div>
  {{/if}}

  {{!-- Cheat button - available when you have dice --}}


  {{!-- Goad button moved to Skills section --}}

  {{!-- Bump Table button moved to Skills section --}}

  {{!-- Pending Bump Retaliation --}}
  {{#if canRetaliate}}
  <div class="control-section bump-retaliation">
    <h3><i class="fa-solid fa-hand"></i> Caught!</h3>
    {{#if isRetaliationTarget}}
    <p>You caught <strong>{{retaliationAttackerName}}</strong> bumping the table!</p>
    <p>Choose one of their dice to re-roll:</p>
    {{else}}
    <p class="gm-override-note"><strong>{{retaliationAttackerName}}</strong> is waiting for retaliation.</p>
    <p>Override and choose a die:</p>
    {{/if}}
    <div class="retaliation-dice">
      {{#each retaliationAttackerDice}}
      <button type="button" class="btn-retaliation-die" data-action="bumpRetaliation" data-die-index="{{this.index}}">
        <img src="icons/svg/d{{this.die}}-grey.svg" alt="d{{this.die}}" class="retaliation-die-icon" />
        <span class="die-type">d{{this.die}}</span>
      </button>
      {{/each}}
    </div>
  </div>
  {{/if}}

  {{#if isGM}}
  <div class="control-section gm-controls">
    <button type="button" class="btn btn-secondary btn-small" data-action="reveal">
      <i class="fa-solid fa-forward"></i> Skip to Staredown
    </button>
  </div>
  {{/if}}
  {{/if}}

  {{!-- Global Accuse Section (Available anytime during round) --}}
  {{#if canAccuse}}
  <div class="control-section accuse-section-global">
    <h3><i class="fa-solid fa-hand-point-right"></i> Accuse</h3>
    <div class="accuse-section">
      <label>Who do you suspect?</label>
      <div class="accuse-portraits">
        {{#each accuseTargets}}
        <div class="accuse-portrait" data-target-id="{{this.id}}" data-target-name="{{this.name}}" tabindex="0">
          <img src="{{this.img}}" alt="{{this.name}}" />
          <span class="portrait-name">{{this.name}}</span>
        </div>
        {{/each}}
      </div>
      <button type="button" class="btn btn-accuse" data-action="accuse" disabled>
        <i class="fa-solid fa-hand-point-right"></i> Accuse ({{accusationCost}}gp)
      </button>
    </div>
    <p class="hint">Click a portrait to select. Cost: 2× ante. Bounty: 5× ante if correct!</p>
  </div>
  {{/if}}

  {{!-- Staredown / Accusation state --}}
  {{#if isInspection}}
  <div class="control-section staredown">
    <h3><i class="fa-solid fa-eye"></i> The Staredown</h3>

    <p class="staredown-text">The dice are revealed. But can you trust what you see?</p>
    <p class="staredown-warning"><i class="fa-solid fa-warning"></i> Accuse an innocent and you forfeit your winnings!
    </p>

    {{#if isInGame}}
    {{!-- V2.0: Scan action - investigate before accusing --}}


    {{/if}}


    {{#if isGM}}
    <button type="button" class="btn btn-success" data-action="skipInspection">
      <i class="fa-solid fa-trophy"></i> Finish Round
    </button>
    {{/if}}
  </div>
  {{/if}}

  {{!-- Revealing state --}}
  {{#if isRevealing}}
  <div class="control-section revealing">
    <h3><i class="fa-solid fa-eye"></i> Revealing...</h3>
    <p>All dice are being revealed!</p>
    <div class="reveal-animation">
      <i class="fa-solid fa-dice fa-spin"></i>
    </div>
  </div>
  {{/if}}

  {{!-- V2.0: Duel state --}}
  {{#if isDuel}}
  <div class="control-section duel">
    <h3><i class="fa-solid fa-crossed-swords"></i> The Duel!</h3>
    <p class="duel-announcement">Contest: <strong>{{duel.stat}}</strong></p>
    <p class="duel-round">Round {{duel.round}}</p>

    <div class="duel-participants">
      {{#each duelParticipants}}
      <div class="duel-participant {{#if this.hasRolled}}rolled{{/if}}">
        <span class="participant-name">{{this.name}}</span>
        {{#if this.hasRolled}}
        <span class="participant-roll">{{this.roll}}</span>
        {{else}}
        <span class="participant-waiting">...</span>
        {{/if}}
      </div>
      {{/each}}
    </div>

    {{#if isMyDuel}}
    <button type="button" class="btn btn-primary btn-large" data-action="duelRoll">
      <i class="fa-solid fa-dice-d20"></i> Roll {{duel.stat}}!
    </button>
    {{else}}
    <p class="duel-waiting"><i class="fa-solid fa-hourglass-half"></i> Waiting for duelists...</p>
    {{/if}}
  </div>
  {{/if}}

  {{!-- Payout state --}}
  {{#if isPayout}}
  <div class="control-section payout">
    <h3><i class="fa-solid fa-trophy"></i> Round Complete!</h3>
    {{#if isInGame}}
    <button type="button" class="btn btn-secondary" data-action="leave">
      <i class="fa-solid fa-door-open"></i> Leave Table
    </button>
    {{/if}}
    {{#if isGM}}
    <button type="button" class="btn btn-success btn-large" data-action="newRound">
      <i class="fa-solid fa-rotate"></i> New Round
    </button>
    {{/if}}
  </div>
  {{/if}}
</div>